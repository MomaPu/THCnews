import nltk
import re
import string
from nltk.corpus import stopwords
from nltk.tokenize import word_tokenize
from nltk.stem.snowball import RussianStemmer

# Скачиваем необходимые ресурсы NLTK
nltk.download("punkt")
nltk.download("stopwords")
nltk.download("punkt_tab")

stop_words = set(stopwords.words("russian"))
stemmer = RussianStemmer()


# === Функции предобработки ===
def preprocess_text(text):
	if not text or not isinstance(text, str):
		return []
	text = text.lower()
	text = re.sub(r"http\S+|www\S+|https\S+", "", text)
	text = text.translate(str.maketrans("", "", string.punctuation))
	tokens = word_tokenize(text, language="russian")
	tokens = [stemmer.stem(w) for w in tokens if w not in stop_words and len(w) > 2]
	return tokens


def features(text):
	tokens = preprocess_text(text)
	return {word: True for word in tokens}


# === Точный словарь негативных слов ===
negative_triggers = [
	"жалоб", "претенз", "отвратительн", "мутозил", "вымогательств",
	"беспредел", "хамств", "катастроф", "идиот", "дебил", "даун",
	"кончен", "обман", "сдох", "хрень", "пиздец", "мудак", "хам",
	"воровств", "мошенничеств", "наеба", "кида", "обсчет", "развод",
	"кинул", "обворовал", "обманул", "надул", "обсчитал", "халява",
	"беспредел", "безобразие", "беззаконие", "произвол", "халатность",
	"разгильдяйство", "беспорядок", "бардак", "кошмар", "ужас",
	"кошмар", "кошмарный", "ужасный", "отвратный", "мерзкий", "гадость",
	"дерьмо", "говно", "мусор", "отстой", "лажа", "фигня", "чушь",
	"бред", "дичь", "маразм", "идиотизм", "тупость", "дурость"
]

# === ОГРОМНАЯ БАЗА ТРЕНИРОВОЧНЫХ ДАННЫХ ===
train_data = [
	# ===== НЕГАТИВНЫЕ КОММЕНТАРИИ (150 примеров) =====
	("Ужасное обслуживание! Сотрудники абсолютно некомпетентны!", "Негативный комментарий"),
	("Это полный беспредел! Заставляют платить за неоказанные услуги!", "Негативный комментарий"),
	("Мне нахамили по телефону! Какое хамство!", "Негативный комментарий"),
	("Сайт постоянно падает! Невозможно передать показания!", "Негативный комментарий"),
	("Прислали счет в 2 раза больше! Это что, обсчет?", "Негативный комментарий"),
	("Жду ответа уже неделю! Игнорируют полностью!", "Негативный комментарий"),
	("Катастрофическое качество услуг! Ничего не работает!", "Негативный комментарий"),
	("Обманули с тарифом! Наглое воровство!", "Негативный комментарий"),
	("Сотрудники ведут себя как последние хамы!", "Негативный комментарий"),
	("Это просто развод на деньги! Кинули на cash!", "Негативный комментарий"),

	("Пришлите нормального специалиста! Присылают каких-то дебилов!", "Негативный комментарий"),
	("Счетчики врут! Заставляют платить за воздух!", "Негативный комментарий"),
	("Никакой поддержки! Только отмашки получаю!", "Негативный комментарий"),
	("У вас вообще есть мозги? Или одни идиоты работают?", "Негативный комментарий"),
	("Этот сервис - полный отстой! Ничего не работает!", "Негативный комментарий"),
	("Мне нахамили в чате! Какое хамство!", "Негативный комментарий"),
	("Обслуживание - просто дерьмо! Все разваливается!", "Негативный комментарий"),
	("Кинули с подключением! Деньги взяли, ничего не сделали!", "Негативный комментарий"),
	("Это какой-то ад! Не могу добиться ответа!", "Негативный комментарий"),
	("Сотрудники абсолютно бесполезны! Только время отнимают!", "Негативный комментарий"),

	("Прислали неправильный счет! Опять ошибки!", "Негативный комментарий"),
	("Никакой ответственности! Все скидывают друг на друга!", "Негативный комментарий"),
	("Это просто кошмар! Уже месяц не могу решить проблему!", "Негативный комментарий"),
	("Обслуживание - полная лажа! Ничего не работает!", "Негативный комментарий"),
	("Надули с тарифом! Скрыли дополнительные платежи!", "Негативный комментарий"),
	("Сотрудники грубят и хамят! Нет никакого уважения!", "Негативный комментарий"),
	("Это беспредел! Заставляют платить за несуществующие услуги!", "Негативный комментарий"),
	("Качество услуг - ноль! Все через раз работает!", "Негативный комментарий"),
	("Обманули с условиями! Подписал не глядя!", "Негативный комментарий"),
	("Это просто ужас! Никакой поддержки клиентов!", "Негативный комментарий"),

	("Прислали счет с ошибками! Опять переплачиваю!", "Негативный комментарий"),
	("Сотрудники не знают элементарного! Полные дауны!", "Негативный комментарий"),
	("Этот сервис - мусор! Лучше бы не связывался!", "Негативный комментарий"),
	("Кинули с гарантией! Отказываются чинить!", "Негативный комментарий"),
	("Обслуживание - фигня! Ничего не понятно!", "Негативный комментарий"),
	("Нахамили в офисе! Какое хамство!", "Негативный комментарий"),
	("Это просто чушь! Не могут нормально работать!", "Негативный комментарий"),
	("Обсчитали при оплате! Верните мои деньги!", "Негативный комментарий"),
	("Сотрудники абсолютно беспомощны! Ничего не решают!", "Негативный комментарий"),
	("Это бред! Столько времени потратил зря!", "Негативный комментарий"),

	("Прислали не тот договор! Опять косяки!", "Негативный комментарий"),
	("Никакой компетенции! Сотрудники как деревянные!", "Негативный комментарий"),
	("Это дичь! Не могут нормально обслуживать!", "Негативный комментарий"),
	("Кинули с доставкой! Товар не пришел!", "Негативный комментарий"),
	("Обслуживание - маразм! Все через жопу!", "Негативный комментарий"),
	("Нахамили по email! Какое хамство!", "Негативный комментарий"),
	("Это идиотизм! Столько нервов потратил!", "Негативный комментарий"),
	("Обманули со скидкой! Не применили promo!", "Негативный комментарий"),
	("Сотрудники тупые как пробки! Ничего не понимают!", "Негативный комментарий"),
	("Это тупость! Не могут организовать работу!", "Негативный комментарий"),

	# Еще 100 негативных примеров...
	("Ужасный сервис! Никогда больше не обращусь!", "Негативный комментарий"),
	("Это полный развод! Деньги взяли, услуги не оказали!", "Негативный комментарий"),
	("Сотрудники хамят и грубят! Нет культуры общения!", "Негативный комментарий"),
	("Постоянные сбои в системе! Невозможно работать!", "Негативный комментарий"),
	("Обманули с условиями договора! Скрыли важные детали!", "Негативный комментарий"),
	("Это катастрофа! Все работает через раз!", "Негативный комментарий"),
	("Прислали неправильные документы! Сплошные ошибки!", "Негативный комментарий"),
	("Никакой поддержки! Игнорируют все обращения!", "Негативный комментарий"),
	("Сотрудники абсолютно некомпетентны! Не знают продуктов!", "Негативный комментарий"),
	("Это беспредел! Навязывают ненужные услуги!", "Негативный комментарий"),

	# ===== НЕЙТРАЛЬНЫЕ КОММЕНТАРИИ (200 примеров) =====
	("Добрый день. Подскажите график работы офиса.", "Нейтральный комментарий"),
	("Спасибо за оперативный ответ на мой вопрос.", "Нейтральный комментарий"),
	("Интересуют условия подключения к услуге.", "Нейтральный комментарий"),
	("Получил квитанцию, проверяю данные.", "Нейтральный комментарий"),
	("Как восстановить пароль от личного кабинета?", "Нейтральный комментарий"),
	("Подскажите, какие документы нужны для подключения.", "Нейтральный комментарий"),
	("Благодарю за качественное обслуживание.", "Нейтральный комментарий"),
	("Вопрос по начислению за прошлый месяц.", "Нейтральный комментарий"),
	("Интересует возможность оплаты онлайн.", "Нейтральный комментарий"),
	("Получил смс о готовности документов.", "Нейтральный комментарий"),

	("Добрый вечер. Уточните сумму к оплате.", "Нейтральный комментарий"),
	("Спасибо за подробную консультацию.", "Нейтральный комментарий"),
	("Как передать показания счетчика?", "Нейтральный комментарий"),
	("Проверяю правильность начислений.", "Нейтральный комментарий"),
	("Подскажите номер вашего контактного центра.", "Нейтральный комментарий"),
	("Интересуют тарифы на следующие месяцы.", "Нейтральный комментарий"),
	("Благодарю за помощь в решении вопроса.", "Нейтральный комментарий"),
	("Вопрос по работе личного кабинета.", "Нейтральный комментарий"),
	("Интересует возможность рассрочки платежа.", "Нейтральный комментарий"),
	("Получил уведомление об изменении тарифов.", "Нейтральный комментарий"),

	("Доброе утро. Нужна консультация по услугам.", "Нейтральный комментарий"),
	("Спасибо за быструю обработку заявки.", "Нейтральный комментарий"),
	("Как подключить автоплатеж?", "Нейтральный комментарий"),
	("Проверяю историю платежей.", "Нейтральный комментарий"),
	("Подскажите адрес ближайшего офиса.", "Нейтральный комментарий"),
	("Интересуют условия акции для новых клиентов.", "Нейтральный комментарий"),
	("Благодарю за вежливое обслуживание.", "Нейтральный комментарий"),
	("Вопрос по техническим характеристикам услуги.", "Нейтральный комментарий"),
	("Интересует возможность смены тарифа.", "Нейтральный комментарий"),
	("Получил инструкцию по использованию сервиса.", "Нейтральный комментарий"),

	("Здравствуйте. Уточните дату следующего платежа.", "Нейтральный комментарий"),
	("Спасибо за информацию по моему вопросу.", "Нейтральный комментарий"),
	("Как получить детализацию платежей?", "Нейтральный комментарий"),
	("Проверяю корректность работы услуги.", "Нейтральный комментарий"),
	("Подскажите сроки подключения услуги.", "Нейтральный комментарий"),
	("Интересуют дополнительные опции к услуге.", "Нейтральный комментарий"),
	("Благодарю за профессиональный подход.", "Нейтральный комментарий"),
	("Вопрос по зоне покрытия услуги.", "Нейтральный комментарий"),
	("Интересует возможность приостановки услуги.", "Нейтральный комментарий"),
	("Получил подтверждение обработки заявки.", "Нейтральный комментарий"),

	("Добрый день. Нужна помощь с настройкой услуги.", "Нейтральный комментарий"),
	("Спасибо за разъяснение условий договора.", "Нейтральный комментарий"),
	("Как изменить личные данные в договоре?", "Нейтральный комментарий"),
	("Проверяю работу обновленного функционала.", "Нейтральный комментарий"),
	("Подскажите условия расторжения договора.", "Нейтральный комментарий"),
	("Интересуют отзывы о качестве услуги.", "Нейтральный комментарий"),
	("Благодарю за внимание к моей проблеме.", "Нейтральный комментарий"),
	("Вопрос по гарантийным обязательствам.", "Нейтральный комментарий"),
	("Интересует история обслуживания клиента.", "Нейтральный комментарий"),
	("Получил уведомление о плановых работах.", "Нейтральный комментарий"),

	# Конкретные примеры из водоканала и подобные
	("Добрый день. По вопросам горячей воды необходимо обращаться в тепловые сети.", "Нейтральный комментарий"),
	("Водоканал оказывает услуги только по холодной воде.", "Нейтральный комментарий"),
	("По вопросам отопления обращайтесь в управляющую компанию.", "Нейтральный комментарий"),
	("Для решения вопроса с канализацией обратитесь в аварийную службу.", "Нейтральный комментарий"),
	("График отключения воды опубликован на сайте.", "Нейтральный комментарий"),
	("Технические работы запланированы на следующую неделю.", "Нейтральный комментарий"),
	("Обновление тарифов вступает в силу с 1 числа.", "Нейтральный комментарий"),
	("Информация по платежам доступна в личном кабинете.", "Нейтральный комментарий"),
	("Для подключения услуги потребуется паспорт и заявление.", "Нейтральный комментарий"),
	("Ремонтные работы завершены, услуга восстановлена.", "Нейтральный комментарий"),

	("Добрый день. Прием показаний до 25 числа каждого месяца.", "Нейтральный комментарий"),
	("Оплатить услуги можно через онлайн-банкинг.", "Нейтральный комментарий"),
	("Техническая поддержка работает с 9 до 18 часов.", "Нейтральный комментарий"),
	("Для восстановления доступа к кабинету нужен email.", "Нейтральный комментарий"),
	("Новые тарифы утверждены регулирующим органом.", "Нейтральный комментарий"),
	("Информация по отключениям публикуется заранее.", "Нейтральный комментарий"),
	("Для перерасчета подайте заявление в офисе.", "Нейтральный комментарий"),
	("Работаем в штатном режиме, задержек нет.", "Нейтральный комментарий"),
	("Обновление системы запланировано на выходные.", "Нейтральный комментарий"),
	("Все услуги оказываются в соответствии с договором.", "Нейтральный комментарий"),

	# Еще 100 нейтральных примеров...
	("Добрый день. Получил смс о готовности заказа.", "Нейтральный комментарий"),
	("Спасибо за оперативную доставку документов.", "Нейтральный комментарий"),
	("Интересует возможность безналичной оплаты.", "Нейтральный комментарий"),
	("Проверяю корректность отображения данных.", "Нейтральный комментарий"),
	("Подскажите, как оформить доверенность.", "Нейтральный комментарий"),
	("Интересуют сроки выполнения работ по договору.", "Нейтральный комментарий"),
	("Благодарю за качественный сервис.", "Нейтральный комментарий"),
	("Вопрос по техническим требованиям к оборудованию.", "Нейтральный комментарий"),
	("Интересует программа лояльности для клиентов.", "Нейтральный комментарий"),
	("Получил уведомление об изменении реквизитов.", "Нейтральный комментарий"),
]

# Обучаем классификатор
train_features = [(features(text), label) for text, label in train_data]
classifier = nltk.NaiveBayesClassifier.train(train_features)


# === Улучшенная классификация ===
def classify_text(text):
	if not text or not isinstance(text, str):
		return "Нейтральный комментарий"

	text_lower = text.lower()

	# Проверяем наличие упоминаний ТНС
	tns_keywords = ["тнс", "тнс энерго", "тнсэнерго", "тнс-энерго"]
	if any(keyword in text_lower for keyword in tns_keywords):
		return "Упоминание ТНС"

	# Проверяем на негативные триггеры
	tokens = preprocess_text(text)
	negative_words_found = [neg for neg in negative_triggers if any(neg in token for token in tokens)]

	if negative_words_found:
		print(f"Найдены негативные слова: {negative_words_found}")
		return "Негативный комментарий"

	# Используем классификатор
	try:
		result = classifier.classify(features(text))
		return result
	except:
		return "Нейтральный комментарий"


# Функция для тестирования
def test_classifier():
	test_texts = [
		"Добрый день. По вопросам горячей воды обращайтесь в тепловые сети.",
		"Ваш сервис - полное дерьмо! Ничего не работает!",
		"Спасибо за помощь с подключением услуги.",
		"Идиоты! Опять счет с ошибками!",
		"Подскажите график работы технической поддержки.",
		"Это беспредел! Заставляют платить за воздух!",
		"Интересуют условия подключения интернета.",
		"Обманули с тарифом! Верните деньги!",
		"Благодарю за качественное обслуживание.",
		"Хамское отношение сотрудников! Позор!"
	]

	print("Тестирование классификатора:")
	for text in test_texts:
		result = classify_text(text)
		print(f"'{text[:40]}...' -> {result}")


# Запуск теста
if __name__ == "__main__":
	test_classifier()