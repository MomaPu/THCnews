import nltk
import re
import string
from nltk.corpus import stopwords
from nltk.tokenize import word_tokenize
from nltk.stem.snowball import RussianStemmer
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

nltk.download("punkt")
nltk.download("stopwords")

stop_words = set(stopwords.words("russian"))
stemmer = RussianStemmer()

# === Функции предобработки ===
def preprocess_text(text):
    text = text.lower()
    text = re.sub(r"http\S+|www\S+|https\S+", "", text)
    text = text.translate(str.maketrans("", "", string.punctuation))
    tokens = word_tokenize(text, language="russian")
    tokens = [stemmer.stem(w) for w in tokens if w not in stop_words]
    return tokens

def features(text):
    tokens = preprocess_text(text)
    return {word: True for word in tokens}

# Для поиска повторяющихся сообщений
def clean_for_similarity(text):
    text = text.lower()
    text = re.sub(r"http\S+|www\S+|https\S+", "", text)
    text = re.sub(r"[0-9]+", "", text)  # удаляем числа
    text = text.translate(str.maketrans("", "", string.punctuation))
    tokens = word_tokenize(text, language="russian")
    tokens = [stemmer.stem(w) for w in tokens if w not in stop_words]
    return " ".join(tokens)

# === Словарь негативных слов ===
negative_triggers = [
    "жалоб", "претенз", "отврат", "плох", "недовольн",
    "мутозил", "ошибк", "сбой", "вымогательств", "обман",
    "беспредел", "хамств", "ненормальн", "катастроф", "ужас",
    "недоброго", "идиоты", "дебилы", "дауны", "конченные",
]


train_data = [
    ("Низкое качество услуг у вас, я согласен! Оно во всем! Начиная с центров обслуживания, разгильдайство и халатность, и заканчивая оказываемыми услугами!", "Негативный комментарий"),
    ("Прошу провести проверку компании ТНС энерго НН на предмет незаконного отключения и вымогательства.", "Негативный комментарий"),
    ("У меня настроена электронная квитанция по ТНС энерго. И все равно не приходят ни в бумажном виде, ни в электронном виде. Приходится заходить на сайт ГНС энерга и смотреть. Только не всегда есть интернет и возможность зайти на сайт и глядеть каждый месяц....", "Упоминание ТНС"),
    ("Хотелось бы привлечь внимание ТНС Энерга: по адресу Мира Iа ежемесячно выставляется счёт за ОДН последние пол года, около 300 рублей. Просьба разобраться, за кого мы платим.", "Упоминание ТНС"),
    ("Каждый месяц приходят завышенные счета, никто не объясняет, за что платим. Очень недоволен работой компании.", "Негативный комментарий"),
    ("ТНС Энерго отключила свет без предупреждения. Это недопустимо!", "Негативный комментарий"),
    ("Не могу передать показания через сайт, постоянно ошибки. Служба поддержки игнорирует.", "Негативный комментарий"),
    ("Счётчик сломался после установки, а меня заставляют платить за все сверхнормативные киловатты. Претензии игнорируют.", "Негативный комментарий"),
    ("Очень плохое обслуживание, сотрудники грубят и не отвечают на вопросы.", "Негативный комментарий"),
    ("Квитанции приходят с ошибками, переплачиваю каждый месяц. Разберитесь!", "Негативный комментарий"),
    ("Сайт компании работает через раз, показания не принимаются. Сервис ужасный!", "Негативный комментарий"),
    ("Подключился к электронным квитанциям ТНС Энерго, удобно отслеживать оплату.", "Упоминание ТНС"),
    ("Интересно, есть ли возможность оплатить счёт через мобильное приложение ТНС?", "Упоминание ТНС"),
    ("Сегодня узнал, что ТНС Энерго обновила тарифы на электроэнергию в Нижнем Новгороде.", "Упоминание ТНС"),
    ("Спасибо сотрудникам ТНС Энерго за быстрый ответ на мой запрос о лицевом счёте.", "Упоминание ТНС"),
    ("Хотел уточнить, как правильно передавать показания счётчика через личный кабинет ТНС.", "Упоминание ТНС"),
    ("ТНС Энерго предоставляет возможность подключения автоматической передачи показаний.", "Упоминание ТНС"),
    ("На сайте ТНС Энерго нашёл полезную информацию о способах оплаты и льготах.", "Упоминание ТНС"),
    ("Вы с ума сошли? Снова пришёл счёт на 15 тысяч за свет! Что за бардак у вас творится?", "Негативный комментарий"),
    ("Хватит нас обманывать! Я три раза звонил, а ваши сотрудники только отшучиваются!", "Негативный комментарий"),
    ("Вы реально думаете, что люди будут терпеть этот беспредел с квитанциями? Отвратительная контора!", "Негативный комментарий"),
    ("Вы сдохли что ли? Опять счёт за свет на 20 тысяч! Это полный ж!", "Негативный комментарий"),
    ("Ваш сайт — полная хрень! Ни передать показания, ни проверить счёт!", "Негативный комментарий"),
    ("Счётчик сломался, а вы заставляете платить? Идиоты!", "Негативный комментарий"),
    ("Этот бардак с квитанциями — просто пиздец! Отвратительная контора!", "Негативный комментарий"),
    ("Ваши сотрудники тупые мудаки, игнорируют жалобы!", "Негативный комментарий"),
    ("Счётчики бракованные, сотрудники хамят — просто жесть!", "Негативный комментарий")

]
train_features = [(features(text), label) for text, label in train_data]
classifier = nltk.NaiveBayesClassifier.train(train_features)

# === Классификация с учетом словаря негативных слов ===
def classify_text(text):
    tokens = preprocess_text(text)
    if any(neg in tokens for neg in negative_triggers):
        return "Негативный комментарий"
    return classifier.classify(features(text))

# === Пример комментариев ===
comments = [
    "Почему ваш сайт моментально ложится, как только я пытаюсь передать показания? Каждый месяц стабильно.",
    "Подключил электронные квитанции, всё удобно.",
    "Сайт компании работает через раз, показания не принимаются.",
    "Сегодня получил квитанцию с ошибкой, нужно исправить.",
    "Очень плохое обслуживание, сотрудники грубят!",
]

# 1. Классификация всех комментариев
labels = [classify_text(c) for c in comments]

# 2. Подготовка для поиска повторяющихся сообщений
cleaned_comments = [clean_for_similarity(c) for c in comments]
vectorizer = TfidfVectorizer()
tfidf_matrix = vectorizer.fit_transform(cleaned_comments)

threshold = 0.45  # порог похожести

# 3. Инициализация списка меток повторов
is_repeated = [False] * len(comments)

# 4. Поиск повторяющихся сообщений (взаимная проверка всех пар)
n = len(comments)
for i in range(n):
    for j in range(i + 1, n):
        sim = cosine_similarity(tfidf_matrix[i], tfidf_matrix[j])[0][0]
        if sim > threshold:
            is_repeated[i] = True
            is_repeated[j] = True

# 5. Обновляем метки с учётом повторов
final_labels = []
for label, repeated in zip(labels, is_repeated):
    if repeated:
        if label == "Негативный комментарий":
            final_labels.append("Негативный повторяющийся комментарий")
        else:
            final_labels.append("Повторяющийся комментарий")
    else:
        final_labels.append(label)

# 6. Сохраняем результат в файл
with open("classified_comments.txt", "w", encoding="utf-8") as f:
    for label, comment in zip(final_labels, comments):
        f.write(f"[{label}] {comment}\n")